---
title: "National Parks"
author: "Evan Canfield"
date: "6/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Library Calls
```{r library calls, message=FALSE, warning=FALSE}
if (!require(tidyverse)) {install.packages('tidyverse')} 
library(tidyverse)
if (!require(readr)) {install.packages('readr')} 
library(readr)
if (!require(stringr)) {install.packages('stringr')} 
library(stringr)
if (!require(data.table)) {install.packages('data.table')} 
library(data.table)
if (!require(broom)) {install.packages('broom')} 
library(broom)
if (!require(plotly)) {install.packages('plotly')} 
library(plotly)
if (!require(ggthemes)) {install.packages('ggthemes')} 
library(ggthemes)
if (!require(RColorBrewer)) {install.packages('RColorBrewer')} 
library(RColorBrewer)
```

#Data Import / Export
```{r data import,  message=FALSE,}
#Visitation Data
nps_summary_complete<- read.csv("./data/annual_summary_report_1904-2018.csv", stringsAsFactors = FALSE)

#Location and Region Data on the Parks
list_np_locations <- read.csv(file = "./data/list_national_parks_location.csv", stringsAsFactors = F)
```

#Data Inspection
```{r}
glimpse(nps_summary_complete)

nps_rec_visits_all <- nps_summary_complete %>% 
  select(ParkName, Year, RecreationVisitors)

glimpse(nps_rec_visits_all)
```

#Reduce to National Parks
```{r}
#Add NP to American Samoa for FOllowing Filters
nps_rec_visits_all$ParkName <- str_replace_all(nps_rec_visits_all$ParkName, "National Park of American Samoa", "National Park of American Samoa NP")

nps_rec_visits_all %>% 
  distinct(ParkName)

nps_rec_visits_np <- nps_rec_visits_all %>% 
  filter(str_detect(string = ParkName, " NP")) %>% 
  filter(str_detect(string = ParkName, " NPRES") == FALSE)

nps_rec_visits_np %>% 
  distinct(ParkName)

glimpse(nps_rec_visits_np)

#Join Location Data
nps_rec_visits_np <- nps_rec_visits_np %>% 
  left_join(y = list_np_locations, by = c("ParkName"))

glimpse(nps_rec_visits_np)

```

#Line Graph - All Values
```{r}
l <- ggplot(data = nps_rec_visits_np, 
            mapping = aes(x = Year, y = RecreationVisitors, color = ParkName)) +
  geom_line() +
  guides(color = FALSE)

ggplotly(l)
```

#Drop Rows from Before National Park
```{r}
nps_rec_visits_np_only <- nps_rec_visits_np %>% 
  filter(Year >= np_established_year )

nps_rec_visits_np_only

m <- ggplot(data = nps_rec_visits_np_only, 
            mapping = aes(x = Year, y = RecreationVisitors, color = ParkName)) +
  geom_line() +
  guides(color = FALSE)

ggplotly(m)

```

#Identify Top 10
```{r}
glimpse(nps_rec_visits_np)

year_filter = 1800

nps_top_10 <- nps_rec_visits_np %>% 
  filter(Year >= year_filter) %>% 
  group_by(Year) %>%
  mutate(total_parks = n_distinct(ParkName)) %>% 
  mutate(visitors_rank = rank(RecreationVisitors)) %>% 
  mutate(np_rank = as.integer(total_parks - visitors_rank + 1)) %>% 
  ungroup() %>% 
  select(ParkName, np_id, np_rank) %>% 
  filter(np_rank <= 10) %>% 
  distinct(ParkName, np_id)

nps_top_10

```

#Line Graph Top 10
```{r}
nps_rec_visits_np_top_10 <- nps_rec_visits_np %>% 
  semi_join(y = nps_top_10, by = c("np_id"))

nps_rec_visits_np_top_10

l <- ggplot(data = nps_rec_visits_np_top_10, 
            mapping = aes(x = Year, y = RecreationVisitors, color = ParkName)) +
  geom_line() +
  theme_minimal()

ggplotly(l) %>% 
  layout(legend = list(x = 0.05, y = 0.99))
```

#Circular Bar Chart - R Grpah Gallery 295 - Data Prep
```{r}
#Filter for 2018
nps_rec_visits_np_2018 <- nps_rec_visits_np %>% 
  filter(Year == 2018)

#Filter Down to Only Park Name
nps_rec_visits_np_2018$ParkName <- str_remove_all(nps_rec_visits_np_2018$ParkName," NP")

glimpse(nps_rec_visits_np_2018)

nps_rec_visits_np_2018$ParkName <- str_remove_all(nps_rec_visits_np_2018$ParkName," & PRES")

glimpse(nps_rec_visits_np_2018)

#Filter Out Wolf Trap
nps_rec_visits_np_2018 <- nps_rec_visits_np_2018 %>% 
  filter(ParkName != 'Wolf Trap for the Performing Arts')

nps_rec_visits_np_2018 <- nps_rec_visits_np_2018 %>% 
  mutate(percent_visit = round(RecreationVisitors/sum(RecreationVisitors)*100,digits = 2))

glimpse(nps_rec_visits_np_2018)

nps_rec_visits_np_2018 %>% 
  arrange(np_id)
```

#Circular Bar Chart - R Grpah Gallery 295
```{r}
p_295 <-  
  ggplot(data = nps_rec_visits_np_2018, 
          mapping = aes(x = as.factor(np_id), y = percent_visit)) +
  geom_bar(stat = "identity", fill = alpha("blue", 0.3)) +
  ylim(-5, 13.5) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-2,4), "cm")     # This remove unnecessary margin around plot
  ) 

p_295

#Wrap in Polar Coordinates
p_295  + coord_polar(start = 0)

```

#Circular Bar Chart With Labels - R Grpah Gallery 296
```{r}
labels <- nps_rec_visits_np_2018
 
# calculate the ANGLE of the labels
number_of_bar <- nrow(labels)

angle <- 90 - 360 * (labels$np_id - 0.5) / number_of_bar     

# I substract 0.5 because the letter must have the angle of the center of the bars. 
#Not extreme right(1) or extreme left (0)
 
# calculate the alignment of labels: right or left
# If I am on the left part of the plot, my labels have currently an angle < -90
labels$hjust <- ifelse( angle < -90, 1, 0)
 
# flip angle BY to make them readable
labels$angle <- ifelse(angle < -90, angle + 180, angle)

#plot
p_296 <-  
  ggplot(data = nps_rec_visits_np_2018, 
          mapping = aes(x = as.factor(np_id), 
                        y = percent_visit)) +
  geom_bar(stat = "identity", fill = alpha("blue", 0.3)) +
  ylim(-3, 13.8) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm")     # This remove unnecessary margin around plot
  ) +
  coord_polar(start = 0) +
  geom_text(data = labels, 
            mapping = aes(x = np_id, 
                          y = percent_visit + 0.5, 
                          label = ParkName,
                          hjust = hjust), 
            color="black", 
            fontface="bold", 
            alpha=0.6, 
            size=2, 
            angle= labels$angle, 
            inherit.aes = FALSE)

p_296
```

#Circular Bar Chart With Labels, Seperated By Region - R Grpah Gallery 296
```{r}
nps_rec_visits_np_2018_cir <- nps_rec_visits_np_2018

#Make NPS Region a Factor
nps_rec_visits_np_2018_cir$nps_region <- as.factor(nps_rec_visits_np_2018_cir$nps_region)

#Arrange Data Input
 nps_rec_visits_np_2018_cir <- nps_rec_visits_np_2018_cir %>%
  arrange(nps_region, RecreationVisitors)

# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(nps_rec_visits_np_2018_cir$nps_region), ncol(nps_rec_visits_np_2018_cir)))
colnames(to_add) <- colnames(nps_rec_visits_np_2018_cir)
to_add$nps_region <- rep(levels(nps_rec_visits_np_2018_cir$nps_region), each=empty_bar)
nps_rec_visits_np_2018_cir <- rbind(nps_rec_visits_np_2018_cir, to_add)
nps_rec_visits_np_2018_cir <- nps_rec_visits_np_2018_cir %>% arrange(nps_region)
nps_rec_visits_np_2018_cir$np_id <- seq(1, nrow(nps_rec_visits_np_2018_cir))


#Assign Labels to the Bars
labels <- nps_rec_visits_np_2018_cir
 
# calculate the ANGLE of the labels
number_of_bar <- nrow(labels)

angle <- 90 - 360 * (labels$np_id - 0.5) / number_of_bar     

# I substract 0.5 because the letter must have the angle of the center of the bars. 
#Not extreme right(1) or extreme left (0)
 
# calculate the alignment of labels: right or left
# If I am on the left part of the plot, my labels have currently an angle < -90
labels$hjust <- ifelse( angle < -90, 1, 0)
 
# flip angle BY to make them readable
labels$angle <- ifelse(angle < -90, angle + 180, angle)

#plot
p_297 <-  
  ggplot(data = nps_rec_visits_np_2018_cir, 
          mapping = aes(x = as.factor(np_id), 
                        y = percent_visit,
                        fill = nps_region)) +
  geom_bar(stat = "identity", alpha = 0.5) +
  ylim(-3, 13.8) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(0, 0, 0, 0, "cm"), # This remove unnecessary margin around plot
    legend.position = "none"
    ) +
  coord_polar(start = 0) +
  geom_text(data = labels,
            mapping = aes(x = np_id,
                          y = percent_visit + 0.5,
                          label = ParkName,
                          hjust = hjust),
            color="black",
            fontface="bold",
            alpha=0.6,
            size=2,
            angle= labels$angle,
            inherit.aes = FALSE)

p_297
```


#Plotly - Circle
```{r}
nps_rec_visits_np_2018_plotly <- nps_rec_visits_np_2018 %>% 
  arrange(RecreationVisitors) %>% 
  mutate(RecreationVisitors.fm = prettyNum(RecreationVisitors, big.mark = "," , scientific = FALSE, ))

glimpse(nps_rec_visits_np_2018_plotly)

# Get incremental angle value

open_space <- 0

n <- nrow(nps_rec_visits_np_2018_plotly) + open_space

dtheta <- 2*pi / (n-1)

theta <- pi / 2
 
# Initialise
l <- c()
x <- c()
y <- c()
xend <- c()
yend <- c()


# Radius of the center white-space circle. If set to zero all bars would eminate from the same point when plotting a circle.
adjust <- 2

# Calculate x and y coordinates
for(ctr in 1:nrow(nps_rec_visits_np_2018_plotly)){
  
  l[ctr] <- nps_rec_visits_np_2018_plotly$percent_visit[ctr] + adjust
  
  x[ctr] <- adjust * cos(theta)
  y[ctr] <- adjust * sin(theta)
  
  xend[ctr] <- l[ctr] * cos(theta)
  yend[ctr] <- l[ctr] * sin(theta)
  
  theta <- theta + dtheta
}

l
x
y
xend
yend
dtheta

plot.df <- data.frame(x, y, xend, yend, nps_region = nps_rec_visits_np_2018_plotly$nps_region)

plot.df

p <- plot_ly(plot.df, 
             x = ~x, y = ~y,
             xend = ~xend, yend = ~yend,
             color = ~nps_region) %>% 
  add_segments(line = list(width = 5),
               hoverinfo = 'text',
               text = ~paste(nps_rec_visits_np_2018_plotly$ParkName,
                      '</br> </br> Visitors: ', nps_rec_visits_np_2018_plotly$RecreationVisitors.fm)
                      )

p
```

#Plotly - sprial
```{r}
nps_rec_visits_np_2018_plotly <- nps_rec_visits_np_2018 %>% 
  arrange(RecreationVisitors) %>% 
  mutate(RecreationVisitors.fm = prettyNum(RecreationVisitors, big.mark = "," , scientific = FALSE, ))

glimpse(nps_rec_visits_np_2018_plotly)

#Import NPS Region Color Table
nps_region_colors <- read.csv("./data/nps_region_colors.csv", stringsAsFactors = FALSE)

glimpse(nps_region_colors)

#Join NPS Region Color to Visits
nps_rec_visits_np_2018_plotly <- nps_rec_visits_np_2018_plotly %>% 
  left_join(y = nps_region_colors, by = c("nps_region" = "nps_region"))

glimpse(nps_rec_visits_np_2018_plotly)

# Adds additional spaces in the data table to create offset if open_space > 0
open_space <- 0

n <- nrow(nps_rec_visits_np_2018_plotly) + open_space

dtheta <- 2*pi / (n-1)

theta <- pi / 2
 
# Initialise
l <- c()
x <- c()
y <- c()
xend <- c()
yend <- c()
segment_length <- c()

A <- 0.22
B <- 0.22

# Radius of the center white-space circle. If set to zero all bars would eminate from the same point when plotting a circle.
adjust <- 5

# Calculate x and y coordinates
for(ctr in 1:nrow(nps_rec_visits_np_2018_plotly)){
  
  l[ctr] <- nps_rec_visits_np_2018_plotly$percent_visit[ctr] + adjust
  
  x.eq <- A*cos(theta)*exp(B*theta) 
  y.eq <- A*sin(theta)*exp(B*theta) 
  
  x[ctr] <- adjust * x.eq
  y[ctr] <- adjust * y.eq
  
  xend[ctr] <- l[ctr] * x.eq
  yend[ctr] <- l[ctr] * y.eq
  
  segment_length[ctr] <- sqrt((xend[ctr]-x[ctr])^2 + (yend[ctr]-y[ctr])^2)
  
  theta <- theta + dtheta
}

legend_layout <- list(
  font = list(
    family = "sans-serif",
    size = 14,
    color = "#000"),
  bg = "transparent",
  x = 1, y = 1)


plot.df <- data.frame(x, y, xend, yend, segment_length, nps_region = nps_rec_visits_np_2018_plotly$nps_region_names)

p1 <- plot_ly(plot.df, 
             x = ~x, y = ~y,
             xend = ~xend, yend = ~yend,
             color = ~nps_rec_visits_np_2018_plotly$html_color_code_stamps) %>% 
  add_segments(line = list(width = 4),
               hoverinfo = 'text',
               text = ~paste(nps_rec_visits_np_2018_plotly$ParkName,
                      '</br> </br> Visitors: ', nps_rec_visits_np_2018_plotly$RecreationVisitors.fm)
                      )

p1


#Add White Radial Lines
p2 <- layout(p1,
            xaxis = list(title = "", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
            yaxis = list(title = "", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
            legend = legend_layout
)

p2
```